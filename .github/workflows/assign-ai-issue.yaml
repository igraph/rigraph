name: Assign AI Issue to Copilot

on:
  # Run hourly
  schedule:
    - cron: "0 * * * *"
  # Allow manual trigger
  workflow_dispatch:
  # Run when workflow changes
  push:
    paths:
      - .github/workflows/assign-ai-issue.yaml

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}
  cancel-in-progress: true

jobs:
  check_fork:
    runs-on: ubuntu-24.04
    outputs:
      is_forked: ${{ steps.check.outputs.is_forked }}
    steps:
      - name: Check if the repo is forked
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          is_forked=$(gh api repos/${{ github.repository }} | jq .fork)
          echo "is_forked=${is_forked}" >> $GITHUB_OUTPUT
        shell: bash

  assign_issue:
    runs-on: ubuntu-24.04
    needs: check_fork
    if: needs.check_fork.outputs.is_forked == 'false'
    permissions:
      issues: write
    steps:
      - name: Find and assign oldest unassigned AI issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Check gh version and upgrade if needed
          current_version=$(gh --version | head -n1 | awk '{print $3}')
          required_version="2.82.1"

          if [ "$(printf '%s\n' "$required_version" "$current_version" | sort -V | head -n1)" != "$required_version" ]; then
            echo "Current gh version ($current_version) is below required ($required_version), upgrading..."
            # Use official installation from GitHub releases
            
            # Get latest version
            latest_version=$(curl -fsSL https://api.github.com/repos/cli/cli/releases/latest | jq -r .tag_name | sed 's/^v//')
            
            # Download and install latest gh
            gh_url="https://github.com/cli/cli/releases/download/v${latest_version}/gh_${latest_version}_linux_amd64.tar.gz"
            echo "Downloading from: $gh_url"
            curl -fsSL "$gh_url" | sudo tar -xz -C /usr/local --strip-components=1
            gh --version
          else
            echo "gh version $current_version is sufficient"
          fi

          # Get all open, unassigned issues with the "AI ðŸ¤–" label, sorted by creation date (oldest first)
          oldest_issue=$(gh issue list \
            --repo "$REPO" \
            --label "AI ðŸ¤–" \
            --state open \
            --json number,createdAt,assignees \
            --jq 'map(select(.assignees | length == 0)) | sort_by(.createdAt) | .[0].number')

          if [ -n "$oldest_issue" ] && [ "$oldest_issue" != "null" ]; then
            echo "Found unassigned AI issue #$oldest_issue"
            echo "Assigning to @copilot"

            # Assign the issue to Copilot using gh issue edit
            gh issue edit "$oldest_issue" --repo "$REPO" --add-assignee copilot

            # Verify that copilot is actually assigned
            assigned_users=$(gh issue view "$oldest_issue" --repo "$REPO" --json assignees --jq '.assignees[].login')

            if echo "$assigned_users" | grep -q "^copilot$"; then
              echo "âœ“ Successfully verified assignment to copilot"
            else
              echo "âœ— Failed to verify assignment to copilot"
              echo "Assignees: $assigned_users"
              exit 1
            fi

            # Add a comment to the issue
            gh issue comment "$oldest_issue" --repo "$REPO" --body "ðŸ¤– This issue has been assigned to Copilot for automated handling."

            echo "Successfully assigned issue #$oldest_issue"
          else
            echo "No unassigned AI issues found"
          fi
        shell: bash

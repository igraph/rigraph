# igraph/tools

## Updating the sources

In the shell:

```sh
./vendor.sh <path-to-cigraph-working-copy>
```

By default, `cigraph` is assumed to be in `../../../igraph`.

There is a CI/CD workflow that runs this very frequently.

## Running Stimulus

Currently, there are only two files generated by Stimulus.
They are version-controlled and depend on various input files.
The logic is governed by the `Makefile-cigraph` file.
To update them, do the following steps:

```sh
make -f Makefile-cigraph src/rinterface.c R/aaa-auto.R
```

### Type Definitions

Stimulus uses type definition files to generate R-to-C interface code:

- **`tools/stimulus/types-RR.yaml`**: Defines R-level type conversions and argument validation for the R wrapper layer. All arguments in autogenerated `*_impl()` functions are validated here before being passed to C.
- **`tools/stimulus/types-RC.yaml`**: Defines C-level type conversions between R's SEXP objects and igraph C types.

When adding support for new types (e.g., `GRAPH_PTR_LIST`, `MATRIX_LIST`):
1. Add the type definition to `types-RR.yaml` with `INCONV` for R-level validation
2. Add the type definition to `types-RC.yaml` with `INCONV`/`OUTCONV` for C conversion
3. Regenerate the interface files with the make command above

## Managing Stimulus with git subrepo

### What is git subrepo?

The Stimulus code generator is vendored into this repository using [`git subrepo`](https://github.com/ingydotnet/git-subrepo), a tool that allows you to include an external git repository as a subdirectory within your main repository.
Unlike git submodules, subrepos are easier to work with because they don't require special checkout commands; the code is directly present in the repository.
This approach gives us the flexibility to test local modifications to Stimulus while still being able to pull upstream updates cleanly.

### Installing git subrepo

If you don't have `git subrepo` installed yet:

```sh
# On macOS with Homebrew
brew install git-subrepo

# Or install from source
git clone https://github.com/ingydotnet/git-subrepo /path/to/git-subrepo
echo 'source /path/to/git-subrepo/.rc' >> ~/.zshrc
```

### Updating Stimulus from upstream

To pull the latest changes from the upstream Stimulus repository:

```sh
# Pull the latest from the main branch
git subrepo pull tools/py-stimulus

# Or pull a specific branch
git subrepo pull tools/py-stimulus -b branch-name

# Or pull a specific commit or tag
git subrepo pull tools/py-stimulus -b v0.21.5
```

This command will:

1. Fetch changes from the upstream Stimulus repository
2. Merge them into the `tools/py-stimulus/` directory
3. Create a merge commit with metadata in `.gitrepo`
4. Update the commit hash in `tools/py-stimulus/.gitrepo`

After pulling, test the changes:

```sh
# Clean the virtualenv to ensure fresh installation
rm -rf .venv

# Regenerate the interface files
make -f Makefile-cigraph src/rinterface.c R/aaa-auto.R
```

### Working with a modified version of Stimulus

If you need to test local changes to Stimulus:

1. **Make your changes** directly in `tools/py-stimulus/`:

   ```sh
   cd tools/py-stimulus
   # Edit files as needed
   vim src/stimulus/some_file.py
   cd ../..
   ```

2. **Test your changes**:

   ```sh
   # Remove the virtualenv to force reinstallation
   rm -rf .venv

   # Regenerate with your modified Stimulus
   make -f Makefile-cigraph src/rinterface.c R/aaa-auto.R
   ```

3. **Commit everything together**:

   ```sh
   git add tools/py-stimulus/ src/rinterface.c R/aaa-auto.R
   git commit -m "feat: update Stimulus and regenerated interface files"
   ```

The modified Stimulus code and generated files will be committed together, making it easy to see what Stimulus changes caused which interface changes.

### Pushing Stimulus changes upstream

If your Stimulus modifications should be contributed back to the upstream repository:

```sh
# Push your changes to the upstream Stimulus repository
git subrepo push tools/py-stimulus

# Or push to a specific branch (useful for PRs)
git subrepo push tools/py-stimulus -b feature-branch-name
```

This will create commits in the upstream Stimulus repository based on the commits you made in `tools/py-stimulus/`.

### Checking subrepo status

To see information about the subrepo:

```sh
git subrepo status tools/py-stimulus
```

This shows the remote URL, branch, and commit hashes.

